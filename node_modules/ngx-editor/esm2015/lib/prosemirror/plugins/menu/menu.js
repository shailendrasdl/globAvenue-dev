import { toggleMark } from 'prosemirror-commands';
import { isNodeActive, isMarkActive, isListItem } from '../../helpers';
import { toggleList, toggleBlockType, toggleWrap } from '../../commands';
import { getIconSvg } from '../../../utils/icons';
import flatDeep from '../../../utils/flatDeep';
import menuItemsMeta from './meta';
const SEPERATOR_CLASSNAME = 'NgxEditor__Seperator';
const MENU_ITEM_CLASSNAME = 'NgxEditor__MenuItem';
const ACTIVE_MENU_ITEM_CLASSNAME = `${MENU_ITEM_CLASSNAME}--Active`;
const DISABLED_CLASSNAME = 'NgxEditor--Disabled';
const DROPDWON_ITEM_CLASSNAME = 'NgxEditor__Dropdown';
const DROPWDOWN_OPEN_CLASSNAME = `${DROPDWON_ITEM_CLASSNAME}--Open`;
const ACTIVE_DROPDOWN_ITEM_CLASSNAME = `${DROPDWON_ITEM_CLASSNAME}--Active`;
const SELECTED_DROPDOWN_ITEM_CLASSNAME = `${DROPDWON_ITEM_CLASSNAME}--Selected`;
const DROPDOWN_ITEMS = new Map();
DROPDOWN_ITEMS.set('heading', ['h1', 'h2', 'h3', 'h4', 'h5', 'h6']);
class DropDownView {
    constructor(dropdownGroup, dropdownFields, editorView, options) {
        this.updates = [];
        this.dropdownGroup = dropdownGroup;
        this.dropdownFields = dropdownFields;
        this.editorView = editorView;
        this.options = options;
    }
    getWrapperDom() {
        let isDropdownOpen = false;
        const dropdown = document.createElement('div');
        const labels = this.options.labels;
        dropdown.classList.add(DROPDWON_ITEM_CLASSNAME);
        const dropdownText = document.createElement('div');
        dropdownText.classList.add(`${DROPDWON_ITEM_CLASSNAME}__Text`);
        dropdownText.textContent = labels[this.dropdownGroup];
        dropdown.appendChild(dropdownText);
        // create dropdown list
        const dropdownMenu = document.createElement('div');
        dropdownMenu.classList.add(`${DROPDWON_ITEM_CLASSNAME}__DropdownMenu`);
        const mouseDownHandler = (e) => {
            e.preventDefault();
            if (!dropdown.contains(e.target)) {
                closeDropdown();
            }
        };
        const openDropdown = (e) => {
            const target = e.target;
            if (dropdownMenu.contains(target)) {
                return;
            }
            dropdown.classList.add(DROPWDOWN_OPEN_CLASSNAME);
            isDropdownOpen = true;
            window.addEventListener('mousedown', mouseDownHandler);
        };
        const closeDropdown = () => {
            dropdown.classList.remove(DROPWDOWN_OPEN_CLASSNAME);
            isDropdownOpen = false;
            window.removeEventListener('mousedown', mouseDownHandler);
        };
        dropdown.addEventListener('click', (e) => {
            e.preventDefault();
            if (!isDropdownOpen) {
                openDropdown(e);
            }
            else {
                closeDropdown();
            }
        });
        this.dropdownFields.forEach(dropdownItem => {
            const menuItem = menuItemsMeta[dropdownItem];
            let text = labels[menuItem.key];
            if (menuItem.key === 'heading') {
                text += ` ${menuItem.attrs.level}`;
            }
            const spec = {
                classNames: [
                    `${DROPDWON_ITEM_CLASSNAME}__Item`
                ],
                textContent: text,
                attrs: {
                    title: text
                },
                activeClass: ACTIVE_DROPDOWN_ITEM_CLASSNAME,
                disabledClass: DISABLED_CLASSNAME
            };
            const menuItemView = new MenuItemView(menuItem, this.editorView, spec);
            const { update, dom } = menuItemView.render();
            // remove open class once clicked on dropdown value
            dom.addEventListener('click', (e) => {
                e.preventDefault();
                closeDropdown();
            });
            // wrapper to execute when update is called
            const dropUpdate = (state) => {
                update(state);
                // update the dropdown content heading when a class is selected
                const activeEl = dropdownMenu.getElementsByClassName(ACTIVE_DROPDOWN_ITEM_CLASSNAME);
                if (activeEl.length) {
                    const el = activeEl[0];
                    dropdownText.textContent = el.textContent;
                    dropdown.classList.add(SELECTED_DROPDOWN_ITEM_CLASSNAME);
                }
                else {
                    // restore default value
                    dropdownText.textContent = labels[this.dropdownGroup];
                    dropdown.classList.remove(SELECTED_DROPDOWN_ITEM_CLASSNAME);
                }
            };
            dropdownMenu.appendChild(dom);
            this.updates.push(dropUpdate);
        });
        dropdown.appendChild(dropdownMenu);
        return dropdown;
    }
    render() {
        this.dom = this.getWrapperDom();
        return {
            dom: this.dom,
            updates: this.updates
        };
    }
}
class MenuItemView {
    constructor(menuItem, editorView, spec) {
        this.menuItem = menuItem;
        this.editorView = editorView;
        this.spec = spec;
    }
    render() {
        const dom = this.dom = this.getDom();
        const { schema } = this.editorView.state;
        const { command } = this.setupCommandListeners();
        const { activeClass, disabledClass } = this.spec;
        const update = (state) => {
            const menuItem = this.menuItem;
            let isActive = false;
            const canExecute = command(this.editorView.state, null);
            if (menuItem.type === 'mark') {
                const type = schema.marks[menuItem.key];
                isActive = isMarkActive(state, type);
            }
            if (menuItem.type === 'node') {
                const type = schema.nodes[menuItem.key];
                isActive = isNodeActive(state, type, menuItem.attrs);
            }
            dom.classList.toggle(activeClass, isActive);
            dom.classList.toggle(disabledClass, !canExecute);
        };
        return {
            dom,
            update
        };
    }
    getDom() {
        const div = document.createElement('div');
        if (this.spec.classNames) {
            this.spec.classNames.forEach(className => {
                div.classList.add(className);
            });
        }
        if (this.spec.attrs) {
            Object.entries(this.spec.attrs).forEach(obj => {
                div.setAttribute(obj[0], obj[1]);
            });
        }
        if (this.spec.innerHTML) {
            div.innerHTML = this.spec.innerHTML;
        }
        if (this.spec.textContent) {
            div.innerHTML = this.spec.textContent;
        }
        return div;
    }
    setupCommandListeners() {
        const { schema } = this.editorView.state;
        let command;
        if (this.menuItem.type === 'mark') {
            command = toggleMark(schema.marks[this.menuItem.key]);
        }
        if (this.menuItem.type === 'node') {
            const type = schema.nodes[this.menuItem.key];
            if (isListItem(type, schema)) {
                command = toggleList(type, schema.nodes.list_item);
            }
            if (type === schema.nodes.heading) {
                command = toggleBlockType(type, schema.nodes.paragraph, { level: this.menuItem.attrs.level });
            }
            if (type === schema.nodes.blockquote) {
                command = toggleWrap(type);
            }
        }
        this.dom.addEventListener('mousedown', (e) => {
            e.preventDefault();
            // don't execute if not left click
            if (e.buttons !== 1) {
                return;
            }
            // execute command
            command(this.editorView.state, this.editorView.dispatch);
        });
        return { command };
    }
}
const getSeperatorDom = () => {
    const div = document.createElement('div');
    div.className = SEPERATOR_CLASSNAME;
    return div;
};
const ɵ0 = getSeperatorDom;
export const renderMenu = (options, editorView, menuDom) => {
    const updates = [];
    const toolbar = options.toolbar;
    toolbar.forEach((group, toolbarIndex) => {
        const isLastMenuGroup = toolbar.length - 1 === toolbarIndex;
        group.forEach((toolbarItem, menuIndex) => {
            const isLastMenuItem = group.length - 1 === menuIndex;
            // render dropdown
            if (typeof toolbarItem === 'object') {
                Object.keys(toolbarItem).forEach((dropdownGroup) => {
                    if (DROPDOWN_ITEMS.has(dropdownGroup)) {
                        const dropdown = toolbarItem[dropdownGroup];
                        const dropdownView = new DropDownView(dropdownGroup, dropdown, editorView, options);
                        const rendered = dropdownView.render();
                        updates.push(rendered.updates);
                        menuDom.appendChild(rendered.dom);
                    }
                    else {
                        console.warn('Unkown dropdown group:', dropdownGroup);
                    }
                });
            }
            // render Icons
            if (typeof toolbarItem === 'string') {
                const menuItem = menuItemsMeta[toolbarItem];
                const labels = options.labels;
                if (menuItem) {
                    const spec = {
                        classNames: [
                            MENU_ITEM_CLASSNAME,
                            `${MENU_ITEM_CLASSNAME}--Icon`,
                        ],
                        innerHTML: getIconSvg(menuItem.icon),
                        attrs: {
                            title: labels[menuItem.i18nKey]
                        },
                        activeClass: ACTIVE_MENU_ITEM_CLASSNAME,
                        disabledClass: DISABLED_CLASSNAME
                    };
                    const menuItemView = new MenuItemView(menuItem, editorView, spec);
                    const { update, dom } = menuItemView.render();
                    menuDom.appendChild(dom);
                    updates.push(update);
                }
            }
            if (typeof toolbarItem === 'function') {
                const { dom, update } = toolbarItem(editorView);
                menuDom.appendChild(dom);
                updates.push(update);
            }
            if (isLastMenuItem && !isLastMenuGroup) {
                const seperatorDom = getSeperatorDom();
                menuDom.appendChild(seperatorDom);
            }
        });
    });
    const combinedUpdates = flatDeep(updates, Infinity);
    return {
        update(state) {
            combinedUpdates.forEach((update) => {
                update(state);
            });
        }
    };
};
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvcHJvc2VtaXJyb3IvcGx1Z2lucy9tZW51L21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBY2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV6RSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxRQUFRLE1BQU0seUJBQXlCLENBQUM7QUFFL0MsT0FBTyxhQUErQixNQUFNLFFBQVEsQ0FBQztBQUVyRCxNQUFNLG1CQUFtQixHQUFHLHNCQUFzQixDQUFDO0FBRW5ELE1BQU0sbUJBQW1CLEdBQUcscUJBQXFCLENBQUM7QUFDbEQsTUFBTSwwQkFBMEIsR0FBRyxHQUFHLG1CQUFtQixVQUFVLENBQUM7QUFDcEUsTUFBTSxrQkFBa0IsR0FBRyxxQkFBcUIsQ0FBQztBQUVqRCxNQUFNLHVCQUF1QixHQUFHLHFCQUFxQixDQUFDO0FBQ3RELE1BQU0sd0JBQXdCLEdBQUcsR0FBRyx1QkFBdUIsUUFBUSxDQUFDO0FBQ3BFLE1BQU0sOEJBQThCLEdBQUcsR0FBRyx1QkFBdUIsVUFBVSxDQUFDO0FBQzVFLE1BQU0sZ0NBQWdDLEdBQUcsR0FBRyx1QkFBdUIsWUFBWSxDQUFDO0FBRWhGLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDakMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7QUFHcEUsTUFBTSxZQUFZO0lB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QixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3RCO1lBRUQsSUFBSSxjQUFjLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ3RDLE1BQU0sWUFBWSxHQUFHLGVBQWUsRUFBRSxDQUFDO2dCQUN2QyxPQUFPLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQ25DO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sZUFBZSxHQUFHLFFBQVEsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFcEQsT0FBTztRQUNMLE1BQU0sQ0FBQyxLQUFrQjtZQUN2QixlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBb0MsRUFBRSxFQUFFO2dCQUMvRCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRvZ2dsZU1hcmsgfSBmcm9tICdwcm9zZW1pcnJvci1jb21tYW5kcyc7XG5pbXBvcnQgeyBFZGl0b3JWaWV3IH0gZnJvbSAncHJvc2VtaXJyb3Itdmlldyc7XG5pbXBvcnQgeyBFZGl0b3JTdGF0ZSB9IGZyb20gJ3Byb3NlbWlycm9yLXN0YXRlJztcbmltcG9ydCB7IE1hcmtUeXBlLCBOb2RlVHlwZSB9IGZyb20gJ3Byb3NlbWlycm9yLW1vZGVsJztcblxuaW1wb3J0IHtcbiAgTWVudUl0ZW1WaWV3U3BlYyxcbiAgVG9vbGJhckl0ZW0sXG4gIFRvb2xiYXJEcm9wZG93bkdyb3VwS2V5cyxcbiAgVG9vbGJhckRyb3Bkb3duR3JvdXBWYWx1ZXMsXG4gIE1lbnVPcHRpb25zLFxuICBDb21tYW5kXG59IGZyb20gJy4uLy4uLy4uL3R5cGVzJztcblxuaW1wb3J0IHsgaXNOb2RlQWN0aXZlLCBpc01hcmtBY3RpdmUsIGlzTGlzdEl0ZW0gfSBmcm9tICcuLi8uLi9oZWxwZXJzJztcbmltcG9ydCB7IHRvZ2dsZUxpc3QsIHRvZ2dsZUJsb2NrVHlwZSwgdG9nZ2xlV3JhcCB9IGZyb20gJy4uLy4uL2NvbW1hbmRzJztcblxuaW1wb3J0IHsgZ2V0SWNvblN2ZyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2ljb25zJztcbmltcG9ydCBmbGF0RGVlcCBmcm9tICcuLi8uLi8uLi91dGlscy9mbGF0RGVlcCc7XG5cbmltcG9ydCBtZW51SXRlbXNNZXRhLCB7IE1lbnVJdGVtTWV0YSB9IGZyb20gJy4vbWV0YSc7XG5cbmNvbnN0IFNFUEVSQVRPUl9DTEFTU05BTUUgPSAnTmd4RWRpdG9yX19TZXBlcmF0b3InO1xuXG5jb25zdCBNRU5VX0lURU1fQ0xBU1NOQU1FID0gJ05neEVkaXRvcl9fTWVudUl0ZW0nO1xuY29uc3QgQUNUSVZFX01FTlVfSVRFTV9DTEFTU05BTUUgPSBgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfS0tQWN0aXZlYDtcbmNvbnN0IERJU0FCTEVEX0NMQVNTTkFNRSA9ICdOZ3hFZGl0b3ItLURpc2FibGVkJztcblxuY29uc3QgRFJPUERXT05fSVRFTV9DTEFTU05BTUUgPSAnTmd4RWRpdG9yX19Ecm9wZG93bic7XG5jb25zdCBEUk9QV0RPV05fT1BFTl9DTEFTU05BTUUgPSBgJHtEUk9QRFdPTl9JVEVNX0NMQVNTTkFNRX0tLU9wZW5gO1xuY29uc3QgQUNUSVZFX0RST1BET1dOX0lURU1fQ0xBU1NOQU1FID0gYCR7RFJPUERXT05fSVRFTV9DTEFTU05BTUV9LS1BY3RpdmVgO1xuY29uc3QgU0VMRUNURURfRFJPUERPV05fSVRFTV9DTEFTU05BTUUgPSBgJHtEUk9QRFdPTl9JVEVNX0NMQVNTTkFNRX0tLVNlbGVjdGVkYDtcblxuY29uc3QgRFJPUERPV05fSVRFTVMgPSBuZXcgTWFwKCk7XG5EUk9QRE9XTl9JVEVNUy5zZXQoJ2hlYWRpbmcnLCBbJ2gxJywgJ2gyJywgJ2gzJywgJ2g0JywgJ2g1JywgJ2g2J10pO1xuXG5cbmNsYXNzIERyb3BEb3duVmlldyB7XG4gIHByaXZhdGUgZHJvcGRvd25Hcm91cDogVG9vbGJhckRyb3Bkb3duR3JvdXBLZXlzO1xuICBwcml2YXRlIGRyb3Bkb3duRmllbGRzOiBUb29sYmFyRHJvcGRvd25Hcm91cFZhbHVlcztcbiAgcHJpdmF0ZSBlZGl0b3JWaWV3OiBFZGl0b3JWaWV3O1xuICBwcml2YXRlIG9wdGlvbnM6IE1lbnVPcHRpb25zO1xuXG4gIGRvbTogSFRNTEVsZW1lbnQ7XG5cbiAgdXBkYXRlcyA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGRyb3Bkb3duR3JvdXA6IFRvb2xiYXJEcm9wZG93bkdyb3VwS2V5cyxcbiAgICBkcm9wZG93bkZpZWxkczogVG9vbGJhckRyb3Bkb3duR3JvdXBWYWx1ZXMsXG4gICAgZWRpdG9yVmlldzogRWRpdG9yVmlldyxcbiAgICBvcHRpb25zOiBNZW51T3B0aW9uc1xuICApIHtcbiAgICB0aGlzLmRyb3Bkb3duR3JvdXAgPSBkcm9wZG93bkdyb3VwO1xuICAgIHRoaXMuZHJvcGRvd25GaWVsZHMgPSBkcm9wZG93bkZpZWxkcztcbiAgICB0aGlzLmVkaXRvclZpZXcgPSBlZGl0b3JWaWV3O1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICBnZXRXcmFwcGVyRG9tKCk6IEhUTUxFbGVtZW50IHtcbiAgICBsZXQgaXNEcm9wZG93bk9wZW4gPSBmYWxzZTtcbiAgICBjb25zdCBkcm9wZG93biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgY29uc3QgbGFiZWxzID0gdGhpcy5vcHRpb25zLmxhYmVscztcblxuICAgIGRyb3Bkb3duLmNsYXNzTGlzdC5hZGQoRFJPUERXT05fSVRFTV9DTEFTU05BTUUpO1xuXG4gICAgY29uc3QgZHJvcGRvd25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgZHJvcGRvd25UZXh0LmNsYXNzTGlzdC5hZGQoYCR7RFJPUERXT05fSVRFTV9DTEFTU05BTUV9X19UZXh0YCk7XG4gICAgZHJvcGRvd25UZXh0LnRleHRDb250ZW50ID0gbGFiZWxzW3RoaXMuZHJvcGRvd25Hcm91cF07XG5cbiAgICBkcm9wZG93bi5hcHBlbmRDaGlsZChkcm9wZG93blRleHQpO1xuXG4gICAgLy8gY3JlYXRlIGRyb3Bkb3duIGxpc3RcbiAgICBjb25zdCBkcm9wZG93bk1lbnUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBkcm9wZG93bk1lbnUuY2xhc3NMaXN0LmFkZChgJHtEUk9QRFdPTl9JVEVNX0NMQVNTTkFNRX1fX0Ryb3Bkb3duTWVudWApO1xuXG4gICAgY29uc3QgbW91c2VEb3duSGFuZGxlciA9IChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBpZiAoIWRyb3Bkb3duLmNvbnRhaW5zKGUudGFyZ2V0IGFzIE5vZGUpKSB7XG4gICAgICAgIGNsb3NlRHJvcGRvd24oKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3Qgb3BlbkRyb3Bkb3duID0gKGU6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHRhcmdldCA9IGUudGFyZ2V0IGFzIEhUTUxFbGVtZW50O1xuXG4gICAgICBpZiAoZHJvcGRvd25NZW51LmNvbnRhaW5zKHRhcmdldCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBkcm9wZG93bi5jbGFzc0xpc3QuYWRkKERST1BXRE9XTl9PUEVOX0NMQVNTTkFNRSk7XG4gICAgICBpc0Ryb3Bkb3duT3BlbiA9IHRydWU7XG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VEb3duSGFuZGxlcik7XG4gICAgfTtcblxuICAgIGNvbnN0IGNsb3NlRHJvcGRvd24gPSAoKSA9PiB7XG4gICAgICBkcm9wZG93bi5jbGFzc0xpc3QucmVtb3ZlKERST1BXRE9XTl9PUEVOX0NMQVNTTkFNRSk7XG4gICAgICBpc0Ryb3Bkb3duT3BlbiA9IGZhbHNlO1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG1vdXNlRG93bkhhbmRsZXIpO1xuICAgIH07XG5cbiAgICBkcm9wZG93bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBpZiAoIWlzRHJvcGRvd25PcGVuKSB7XG4gICAgICAgIG9wZW5Ecm9wZG93bihlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNsb3NlRHJvcGRvd24oKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuZHJvcGRvd25GaWVsZHMuZm9yRWFjaChkcm9wZG93bkl0ZW0gPT4ge1xuICAgICAgY29uc3QgbWVudUl0ZW0gPSBtZW51SXRlbXNNZXRhW2Ryb3Bkb3duSXRlbV07XG5cbiAgICAgIGxldCB0ZXh0ID0gbGFiZWxzW21lbnVJdGVtLmtleV07XG5cbiAgICAgIGlmIChtZW51SXRlbS5rZXkgPT09ICdoZWFkaW5nJykge1xuICAgICAgICB0ZXh0ICs9IGAgJHttZW51SXRlbS5hdHRycy5sZXZlbH1gO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzcGVjOiBNZW51SXRlbVZpZXdTcGVjID0ge1xuICAgICAgICBjbGFzc05hbWVzOiBbXG4gICAgICAgICAgYCR7RFJPUERXT05fSVRFTV9DTEFTU05BTUV9X19JdGVtYFxuICAgICAgICBdLFxuICAgICAgICB0ZXh0Q29udGVudDogdGV4dCxcbiAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICB0aXRsZTogdGV4dFxuICAgICAgICB9LFxuICAgICAgICBhY3RpdmVDbGFzczogQUNUSVZFX0RST1BET1dOX0lURU1fQ0xBU1NOQU1FLFxuICAgICAgICBkaXNhYmxlZENsYXNzOiBESVNBQkxFRF9DTEFTU05BTUVcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1lbnVJdGVtVmlldyA9IG5ldyBNZW51SXRlbVZpZXcobWVudUl0ZW0sIHRoaXMuZWRpdG9yVmlldywgc3BlYyk7XG4gICAgICBjb25zdCB7IHVwZGF0ZSwgZG9tIH0gPSBtZW51SXRlbVZpZXcucmVuZGVyKCk7XG5cbiAgICAgIC8vIHJlbW92ZSBvcGVuIGNsYXNzIG9uY2UgY2xpY2tlZCBvbiBkcm9wZG93biB2YWx1ZVxuICAgICAgZG9tLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGU6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBjbG9zZURyb3Bkb3duKCk7XG4gICAgICB9KTtcblxuICAgICAgLy8gd3JhcHBlciB0byBleGVjdXRlIHdoZW4gdXBkYXRlIGlzIGNhbGxlZFxuICAgICAgY29uc3QgZHJvcFVwZGF0ZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUpID0+IHtcbiAgICAgICAgdXBkYXRlKHN0YXRlKTtcblxuICAgICAgICAvLyB1cGRhdGUgdGhlIGRyb3Bkb3duIGNvbnRlbnQgaGVhZGluZyB3aGVuIGEgY2xhc3MgaXMgc2VsZWN0ZWRcbiAgICAgICAgY29uc3QgYWN0aXZlRWwgPSBkcm9wZG93bk1lbnUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShBQ1RJVkVfRFJPUERPV05fSVRFTV9DTEFTU05BTUUpO1xuICAgICAgICBpZiAoYWN0aXZlRWwubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgZWwgPSBhY3RpdmVFbFswXTtcbiAgICAgICAgICBkcm9wZG93blRleHQudGV4dENvbnRlbnQgPSBlbC50ZXh0Q29udGVudDtcbiAgICAgICAgICBkcm9wZG93bi5jbGFzc0xpc3QuYWRkKFNFTEVDVEVEX0RST1BET1dOX0lURU1fQ0xBU1NOQU1FKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyByZXN0b3JlIGRlZmF1bHQgdmFsdWVcbiAgICAgICAgICBkcm9wZG93blRleHQudGV4dENvbnRlbnQgPSBsYWJlbHNbdGhpcy5kcm9wZG93bkdyb3VwXTtcbiAgICAgICAgICBkcm9wZG93bi5jbGFzc0xpc3QucmVtb3ZlKFNFTEVDVEVEX0RST1BET1dOX0lURU1fQ0xBU1NOQU1FKTtcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgZHJvcGRvd25NZW51LmFwcGVuZENoaWxkKGRvbSk7XG4gICAgICB0aGlzLnVwZGF0ZXMucHVzaChkcm9wVXBkYXRlKTtcbiAgICB9KTtcblxuICAgIGRyb3Bkb3duLmFwcGVuZENoaWxkKGRyb3Bkb3duTWVudSk7XG4gICAgcmV0dXJuIGRyb3Bkb3duO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHRoaXMuZG9tID0gdGhpcy5nZXRXcmFwcGVyRG9tKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZG9tOiB0aGlzLmRvbSxcbiAgICAgIHVwZGF0ZXM6IHRoaXMudXBkYXRlc1xuICAgIH07XG4gIH1cbn1cblxuY2xhc3MgTWVudUl0ZW1WaWV3IHtcbiAgcHJpdmF0ZSBtZW51SXRlbTogTWVudUl0ZW1NZXRhO1xuICBwcml2YXRlIGVkaXRvclZpZXc6IEVkaXRvclZpZXc7XG4gIHByaXZhdGUgc3BlYzogTWVudUl0ZW1WaWV3U3BlYztcblxuICBkb206IEhUTUxFbGVtZW50O1xuXG4gIGNvbnN0cnVjdG9yKG1lbnVJdGVtOiBNZW51SXRlbU1ldGEsIGVkaXRvclZpZXc6IEVkaXRvclZpZXcsIHNwZWM6IE1lbnVJdGVtVmlld1NwZWMpIHtcbiAgICB0aGlzLm1lbnVJdGVtID0gbWVudUl0ZW07XG4gICAgdGhpcy5lZGl0b3JWaWV3ID0gZWRpdG9yVmlldztcbiAgICB0aGlzLnNwZWMgPSBzcGVjO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IGRvbSA9IHRoaXMuZG9tID0gdGhpcy5nZXREb20oKTtcbiAgICBjb25zdCB7IHNjaGVtYSB9ID0gdGhpcy5lZGl0b3JWaWV3LnN0YXRlO1xuICAgIGNvbnN0IHsgY29tbWFuZCB9ID0gdGhpcy5zZXR1cENvbW1hbmRMaXN0ZW5lcnMoKTtcblxuICAgIGNvbnN0IHsgYWN0aXZlQ2xhc3MsIGRpc2FibGVkQ2xhc3MgfSA9IHRoaXMuc3BlYztcblxuICAgIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUpOiB2b2lkID0+IHtcbiAgICAgIGNvbnN0IG1lbnVJdGVtID0gdGhpcy5tZW51SXRlbTtcbiAgICAgIGxldCBpc0FjdGl2ZSA9IGZhbHNlO1xuXG4gICAgICBjb25zdCBjYW5FeGVjdXRlID0gY29tbWFuZCh0aGlzLmVkaXRvclZpZXcuc3RhdGUsIG51bGwpO1xuXG4gICAgICBpZiAobWVudUl0ZW0udHlwZSA9PT0gJ21hcmsnKSB7XG4gICAgICAgIGNvbnN0IHR5cGU6IE1hcmtUeXBlID0gc2NoZW1hLm1hcmtzW21lbnVJdGVtLmtleV07XG4gICAgICAgIGlzQWN0aXZlID0gaXNNYXJrQWN0aXZlKHN0YXRlLCB0eXBlKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG1lbnVJdGVtLnR5cGUgPT09ICdub2RlJykge1xuICAgICAgICBjb25zdCB0eXBlOiBOb2RlVHlwZSA9IHNjaGVtYS5ub2Rlc1ttZW51SXRlbS5rZXldO1xuICAgICAgICBpc0FjdGl2ZSA9IGlzTm9kZUFjdGl2ZShzdGF0ZSwgdHlwZSwgbWVudUl0ZW0uYXR0cnMpO1xuICAgICAgfVxuXG4gICAgICBkb20uY2xhc3NMaXN0LnRvZ2dsZShhY3RpdmVDbGFzcywgaXNBY3RpdmUpO1xuICAgICAgZG9tLmNsYXNzTGlzdC50b2dnbGUoZGlzYWJsZWRDbGFzcywgIWNhbkV4ZWN1dGUpO1xuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgZG9tLFxuICAgICAgdXBkYXRlXG4gICAgfTtcbiAgfVxuXG4gIGdldERvbSgpOiBIVE1MRWxlbWVudCB7XG4gICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICBpZiAodGhpcy5zcGVjLmNsYXNzTmFtZXMpIHtcbiAgICAgIHRoaXMuc3BlYy5jbGFzc05hbWVzLmZvckVhY2goY2xhc3NOYW1lID0+IHtcbiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNwZWMuYXR0cnMpIHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKHRoaXMuc3BlYy5hdHRycykuZm9yRWFjaChvYmogPT4ge1xuICAgICAgICBkaXYuc2V0QXR0cmlidXRlKG9ialswXSwgb2JqWzFdKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNwZWMuaW5uZXJIVE1MKSB7XG4gICAgICBkaXYuaW5uZXJIVE1MID0gdGhpcy5zcGVjLmlubmVySFRNTDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zcGVjLnRleHRDb250ZW50KSB7XG4gICAgICBkaXYuaW5uZXJIVE1MID0gdGhpcy5zcGVjLnRleHRDb250ZW50O1xuICAgIH1cblxuICAgIHJldHVybiBkaXY7XG4gIH1cblxuICBwcml2YXRlIHNldHVwQ29tbWFuZExpc3RlbmVycygpIHtcbiAgICBjb25zdCB7IHNjaGVtYSB9ID0gdGhpcy5lZGl0b3JWaWV3LnN0YXRlO1xuXG4gICAgbGV0IGNvbW1hbmQ6IENvbW1hbmQ7XG5cbiAgICBpZiAodGhpcy5tZW51SXRlbS50eXBlID09PSAnbWFyaycpIHtcbiAgICAgIGNvbW1hbmQgPSB0b2dnbGVNYXJrKHNjaGVtYS5tYXJrc1t0aGlzLm1lbnVJdGVtLmtleV0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm1lbnVJdGVtLnR5cGUgPT09ICdub2RlJykge1xuICAgICAgY29uc3QgdHlwZSA9IHNjaGVtYS5ub2Rlc1t0aGlzLm1lbnVJdGVtLmtleV07XG5cbiAgICAgIGlmIChpc0xpc3RJdGVtKHR5cGUsIHNjaGVtYSkpIHtcbiAgICAgICAgY29tbWFuZCA9IHRvZ2dsZUxpc3QodHlwZSwgc2NoZW1hLm5vZGVzLmxpc3RfaXRlbSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlID09PSBzY2hlbWEubm9kZXMuaGVhZGluZykge1xuICAgICAgICBjb21tYW5kID0gdG9nZ2xlQmxvY2tUeXBlKHR5cGUsIHNjaGVtYS5ub2Rlcy5wYXJhZ3JhcGgsIHsgbGV2ZWw6IHRoaXMubWVudUl0ZW0uYXR0cnMubGV2ZWwgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlID09PSBzY2hlbWEubm9kZXMuYmxvY2txdW90ZSkge1xuICAgICAgICBjb21tYW5kID0gdG9nZ2xlV3JhcCh0eXBlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmRvbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAvLyBkb24ndCBleGVjdXRlIGlmIG5vdCBsZWZ0IGNsaWNrXG4gICAgICBpZiAoZS5idXR0b25zICE9PSAxKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gZXhlY3V0ZSBjb21tYW5kXG4gICAgICBjb21tYW5kKHRoaXMuZWRpdG9yVmlldy5zdGF0ZSwgdGhpcy5lZGl0b3JWaWV3LmRpc3BhdGNoKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7IGNvbW1hbmQgfTtcbiAgfVxufVxuXG5jb25zdCBnZXRTZXBlcmF0b3JEb20gPSAoKTogSFRNTEVsZW1lbnQgPT4ge1xuICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgZGl2LmNsYXNzTmFtZSA9IFNFUEVSQVRPUl9DTEFTU05BTUU7XG4gIHJldHVybiBkaXY7XG59O1xuXG5leHBvcnQgY29uc3QgcmVuZGVyTWVudSA9IChvcHRpb25zOiBNZW51T3B0aW9ucywgZWRpdG9yVmlldzogRWRpdG9yVmlldywgbWVudURvbTogSFRNTEVsZW1lbnQpID0+IHtcbiAgY29uc3QgdXBkYXRlczogYW55W10gPSBbXTtcblxuICBjb25zdCB0b29sYmFyID0gb3B0aW9ucy50b29sYmFyO1xuXG4gIHRvb2xiYXIuZm9yRWFjaCgoZ3JvdXA6IFRvb2xiYXJJdGVtW10sIHRvb2xiYXJJbmRleDogbnVtYmVyKTogdm9pZCA9PiB7XG4gICAgY29uc3QgaXNMYXN0TWVudUdyb3VwID0gdG9vbGJhci5sZW5ndGggLSAxID09PSB0b29sYmFySW5kZXg7XG5cbiAgICBncm91cC5mb3JFYWNoKCh0b29sYmFySXRlbTogVG9vbGJhckl0ZW0sIG1lbnVJbmRleDogbnVtYmVyKTogdm9pZCA9PiB7XG4gICAgICBjb25zdCBpc0xhc3RNZW51SXRlbSA9IGdyb3VwLmxlbmd0aCAtIDEgPT09IG1lbnVJbmRleDtcblxuICAgICAgLy8gcmVuZGVyIGRyb3Bkb3duXG4gICAgICBpZiAodHlwZW9mIHRvb2xiYXJJdGVtID09PSAnb2JqZWN0Jykge1xuICAgICAgICBPYmplY3Qua2V5cyh0b29sYmFySXRlbSkuZm9yRWFjaCgoZHJvcGRvd25Hcm91cDogVG9vbGJhckRyb3Bkb3duR3JvdXBLZXlzKSA9PiB7XG4gICAgICAgICAgaWYgKERST1BET1dOX0lURU1TLmhhcyhkcm9wZG93bkdyb3VwKSkge1xuICAgICAgICAgICAgY29uc3QgZHJvcGRvd246IFRvb2xiYXJEcm9wZG93bkdyb3VwVmFsdWVzID0gdG9vbGJhckl0ZW1bZHJvcGRvd25Hcm91cF07XG5cbiAgICAgICAgICAgIGNvbnN0IGRyb3Bkb3duVmlldyA9IG5ldyBEcm9wRG93blZpZXcoZHJvcGRvd25Hcm91cCwgZHJvcGRvd24sIGVkaXRvclZpZXcsIG9wdGlvbnMpO1xuICAgICAgICAgICAgY29uc3QgcmVuZGVyZWQgPSBkcm9wZG93blZpZXcucmVuZGVyKCk7XG4gICAgICAgICAgICB1cGRhdGVzLnB1c2gocmVuZGVyZWQudXBkYXRlcyk7XG4gICAgICAgICAgICBtZW51RG9tLmFwcGVuZENoaWxkKHJlbmRlcmVkLmRvbSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignVW5rb3duIGRyb3Bkb3duIGdyb3VwOicsIGRyb3Bkb3duR3JvdXApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHJlbmRlciBJY29uc1xuICAgICAgaWYgKHR5cGVvZiB0b29sYmFySXRlbSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgbWVudUl0ZW0gPSBtZW51SXRlbXNNZXRhW3Rvb2xiYXJJdGVtXTtcblxuICAgICAgICBjb25zdCBsYWJlbHMgPSBvcHRpb25zLmxhYmVscztcblxuICAgICAgICBpZiAobWVudUl0ZW0pIHtcbiAgICAgICAgICBjb25zdCBzcGVjOiBNZW51SXRlbVZpZXdTcGVjID0ge1xuICAgICAgICAgICAgY2xhc3NOYW1lczogW1xuICAgICAgICAgICAgICBNRU5VX0lURU1fQ0xBU1NOQU1FLFxuICAgICAgICAgICAgICBgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfS0tSWNvbmAsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgaW5uZXJIVE1MOiBnZXRJY29uU3ZnKG1lbnVJdGVtLmljb24pLFxuICAgICAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICAgICAgdGl0bGU6IGxhYmVsc1ttZW51SXRlbS5pMThuS2V5XVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGFjdGl2ZUNsYXNzOiBBQ1RJVkVfTUVOVV9JVEVNX0NMQVNTTkFNRSxcbiAgICAgICAgICAgIGRpc2FibGVkQ2xhc3M6IERJU0FCTEVEX0NMQVNTTkFNRVxuICAgICAgICAgIH07XG5cbiAgICAgICAgICBjb25zdCBtZW51SXRlbVZpZXcgPSBuZXcgTWVudUl0ZW1WaWV3KG1lbnVJdGVtLCBlZGl0b3JWaWV3LCBzcGVjKTtcbiAgICAgICAgICBjb25zdCB7IHVwZGF0ZSwgZG9tIH0gPSBtZW51SXRlbVZpZXcucmVuZGVyKCk7XG5cbiAgICAgICAgICBtZW51RG9tLmFwcGVuZENoaWxkKGRvbSk7XG4gICAgICAgICAgdXBkYXRlcy5wdXNoKHVwZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVvZiB0b29sYmFySXRlbSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBjb25zdCB7IGRvbSwgdXBkYXRlIH0gPSB0b29sYmFySXRlbShlZGl0b3JWaWV3KTtcbiAgICAgICAgbWVudURvbS5hcHBlbmRDaGlsZChkb20pO1xuICAgICAgICB1cGRhdGVzLnB1c2godXBkYXRlKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzTGFzdE1lbnVJdGVtICYmICFpc0xhc3RNZW51R3JvdXApIHtcbiAgICAgICAgY29uc3Qgc2VwZXJhdG9yRG9tID0gZ2V0U2VwZXJhdG9yRG9tKCk7XG4gICAgICAgIG1lbnVEb20uYXBwZW5kQ2hpbGQoc2VwZXJhdG9yRG9tKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgY29uc3QgY29tYmluZWRVcGRhdGVzID0gZmxhdERlZXAodXBkYXRlcywgSW5maW5pdHkpO1xuXG4gIHJldHVybiB7XG4gICAgdXBkYXRlKHN0YXRlOiBFZGl0b3JTdGF0ZSkge1xuICAgICAgY29tYmluZWRVcGRhdGVzLmZvckVhY2goKHVwZGF0ZTogKHN0YXRlOiBFZGl0b3JTdGF0ZSkgPT4gdm9pZCkgPT4ge1xuICAgICAgICB1cGRhdGUoc3RhdGUpO1xuICAgICAgfSk7XG4gICAgfVxuICB9O1xufTtcbiJdfQ==